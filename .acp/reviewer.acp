acp {
  version = "0.1"
  project = "acp-pr-reviewer"
}

variable "openai_api_key" {
  type        = string
  description = "OpenAI API key"
  sensitive   = true
}

variable "github_personal_access_token" {
  type        = string
  description = "GitHub Personal Access Token"
  sensitive   = true
}

provider "llm.openai" "default" {
  api_key = var.openai_api_key
  default_params {
    temperature = 0.2
    max_tokens  = 1800
  }
}

server "github" {
  type      = "mcp"
  transport = "stdio"
  command   = ["npx", "@modelcontextprotocol/server-github"]
  auth {
    token = var.github_personal_access_token
  }
}

capability "get_pr" {
  server      = server.github
  method      = "get_pull_request"
  side_effect = "read"
}

capability "list_pr_files" {
  server      = server.github
  method      = "get_pull_request_files"
  side_effect = "read"
}

capability "create_review" {
  server           = server.github
  method           = "create_pull_request_review"
  side_effect      = "write"
  requires_approval = true
}

policy "ci_safe" {
  budgets { max_cost_usd_per_run = 0.25 }
  budgets { max_capability_calls = 10 }
  budgets { timeout_seconds = 60 }
}

model "gpt4o_mini" {
  provider = provider.llm.openai.default
  id       = "gpt-4o-mini"
}

model "gpt4o" {
  provider = provider.llm.openai.default
  id       = "gpt-4o"
}

agent "reviewer" {
  model           = model.gpt4o_mini
  fallback_models = [model.gpt4o]

  instructions = <<EOT
You are a senior staff software engineer reviewing a GitHub pull request.

You will receive:
- title
- body (description)
- diff (unified patch)

Return ONLY GitHub-flavored Markdown, with this exact structure:

## ACP Review Summary
- **What changed:** ...
- **Risk level:** Low | Medium | High (pick one)
- **Primary concerns:** (0-3 bullets)

## Findings
### Correctness
- ...

### Security
- ...

### Performance / Cost
- ...

### Maintainability
- ...

## Suggested Changes (Actionable)
1. ...

## Questions (If Needed)
- ...

Rules:
- Be precise and cite file paths or symbols when visible in the diff.
- If the diff is too large, prioritize high-risk areas and state what you skipped.
- Do not invent context that is not present in the diff/body.
EOT

  allow  = [capability.get_pr, capability.list_pr_files, capability.create_review]
  policy = policy.ci_safe
}

workflow "review_pr" {
  entry = step.review

  step "review" {
    type  = "llm"
    agent = agent.reviewer

    input {
      title = input.title
      body  = input.body
      diff  = input.diff
    }

    output "comment_markdown" { from = result.text }

    next = step.end
  }

  step "end" { type = "end" }
}
